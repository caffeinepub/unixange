{
  "kind": "build_request",
  "title": "Fix login + profile onboarding flow stuck on loading",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Fix the authenticated user flow so the app never gets stuck on the \"Loading your profile...\" screen due to a missing/cleared auth intent (login vs signup). If `authIntent` is unavailable (e.g., lost across the Internet Identity redirect), the UI must still resolve deterministically: (a) if a caller profile exists, render the app; (b) if no profile exists, show a clear profile creation path (equivalent to signup) without an infinite loading state.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "the login with the profiles are not working",
          "its just leading fix it"
        ]
      },
      "acceptanceCriteria": [
        "After successful Internet Identity authentication, users are not stuck on a perpetual loading screen.",
        "If the user already has a saved profile, the app renders the normal routes (Homepage/Buy/Sell/Rent/Lost & Found) without requiring `authIntent` to be present.",
        "If the user does not have a saved profile, the user is presented with a working profile creation UI and can complete it successfully.",
        "No redirect loop occurs between login UI and the ProfileSetup gate."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Harden the ProfileSetup gating logic to handle the full matrix of states without dead-ends: unauthenticated, authenticated+profile loading, authenticated+profile exists but invalid domain, authenticated+no profile. Ensure all states have a terminal UI outcome and that the profile query result (exists vs null) can be used even when auth intent is missing.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "the login with the profiles are not working"
        ]
      },
      "acceptanceCriteria": [
        "There is no state where the gate requires `authIntent === null` to resolve before it can proceed if the profile query has already returned.",
        "When authenticated and the profile fetch returns `null`, the user can proceed to create a profile (and cannot access the app until profile creation succeeds).",
        "When authenticated and the profile fetch returns a valid profile, the gate renders children immediately.",
        "When authenticated and the profile exists but email is not @jainuniversity.ac.in, an access denied screen is shown with a working logout action."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Ensure React Query profile fetching and actor/identity initialization do not produce false \"Unauthorized\" failures that break onboarding. The profile fetch must only run when the user is authenticated and an authenticated actor is ready, and any transient actor/identity transitions during login must not trap the UI in loading or error loops.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "the login with the profiles are not working"
        ]
      },
      "acceptanceCriteria": [
        "During login transitions, `getCallerUserProfile` does not spam errors and does not prevent the gate from resolving once the actor/identity is ready.",
        "Refreshing the page while already authenticated and having a profile lands in the app successfully (no forced profile setup, no stuck loading).",
        "Logging out clears profile state and returns to the unauthenticated welcome screen reliably."
      ]
    }
  ],
  "constraints": [
    "Do not change or expand scope to include an admin portal or admin email allowlisting in this build.",
    "Do not edit any frontend files under the immutable paths listed in SYSTEM_CONTEXT.frontend.immutablePaths.",
    "Keep user-facing text in English."
  ],
  "nonGoals": [
    "Building the admin portal.",
    "Changing the Jain University email gate rules or supported domains.",
    "Adding new marketplace features (buy/sell/rent/lost-found functionality changes)."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}